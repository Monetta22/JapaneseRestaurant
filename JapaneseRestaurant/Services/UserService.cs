using System.Security.Cryptography;
using System.Text;
using System.Text.Json;
namespace JapaneseRestaurant.Services { public class UserService { private readonly string usersFile = Path.Combine(AppContext.BaseDirectory, "Data", "users.json"); private List<UserRecord> _users = new(); public UserService() { EnsureDataFile(); Load(); } private void EnsureDataFile() { var dir = Path.GetDirectoryName(usersFile)!; if (!Directory.Exists(dir)) Directory.CreateDirectory(dir); if (!File.Exists(usersFile)) { _users = new List<UserRecord> { new UserRecord { Username = "admin", PasswordHash = Hash("admin") } }; Save(); } } private void Load() { try { var json = File.ReadAllText(usersFile); var list = JsonSerializer.Deserialize<List<UserRecord>>(json); if (list != null) _users = list; } catch { _users = new(); } } private void Save() { var json = JsonSerializer.Serialize(_users, new JsonSerializerOptions { WriteIndented = true }); File.WriteAllText(usersFile, json); } public bool ValidateUser(string user, string password) { if (string.IsNullOrWhiteSpace(user) || string.IsNullOrWhiteSpace(password)) return false; var hash = Hash(password); return _users.Any(u => u.Username.Equals(user, StringComparison.OrdinalIgnoreCase) && u.PasswordHash == hash); } public bool RegisterUser(string user, string password) { if (_users.Any(u => u.Username.Equals(user, StringComparison.OrdinalIgnoreCase))) return false; _users.Add(new UserRecord { Username = user, PasswordHash = Hash(password) }); Save(); return true; } private string Hash(string input) { using var sha = SHA256.Create(); var bytes = sha.ComputeHash(Encoding.UTF8.GetBytes(input)); return Convert.ToHexString(bytes); } private class UserRecord { public string Username { get; set; } = string.Empty; public string PasswordHash { get; set; } = string.Empty; } } }